# Account Setup & Profile Creation

## üîê –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞

### –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase Auth**
   - –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `signUpAction(email, password)` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `auth.users`
   - Supabase –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `id` (UUID) –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è**
   - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `profiles`
   - –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å:
     - `id` = `user.id` (UUID –∏–∑ auth.users)
     - `role` = `'student'` (—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
     - `created_at` = —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email:
     - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "An account with this email already exists. Please sign in instead."
     - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

### –ö–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è

```typescript
// app/actions/authActions.ts - signUpAction()

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
const { error: profileError } = await supabase
  .from('profiles')
  .upsert(
    {
      id: data.user.id,
      role: 'student',
    },
    {
      onConflict: 'id',
    }
  );
```

**–ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `upsert`?**
- –ï—Å–ª–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å, `upsert` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –æ—à–∏–±–∫—É –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω (—Ö–æ—Ç—è –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ)
- –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç, –æ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `profiles`

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  role TEXT NOT NULL CHECK (role IN ('teacher', 'student')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### –ü–æ–ª—è:
- **`id`** - UUID, —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `auth.users.id` (foreign key)
- **`role`** - –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `'teacher'` –∏–ª–∏ `'student'`
- **`created_at`** - –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è

---

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: Database Trigger

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–æ–∑–¥–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–∏–≥–≥–µ—Ä –≤ Supabase:

```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, role)
  VALUES (NEW.id, 'student')
  ON CONFLICT (id) DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- –¢—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä:**
- –ö–æ–¥ –≤ `signUpAction` –≤—Å–µ —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–±–ª–∞–≥–æ–¥–∞—Ä—è `upsert` —Å `ON CONFLICT`)
- –¢—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä–≤—ã–º, –∞ `upsert` –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è:

1. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   ```bash
   # –û—Ç–∫—Ä–æ–π—Ç–µ /auth/register
   # –í–≤–µ–¥–∏—Ç–µ email –∏ password
   # –ù–∞–∂–º–∏—Ç–µ "Create Account"
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Supabase Dashboard:**
   - **Authentication ‚Üí Users**: –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
   - **Table Editor ‚Üí profiles**: –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å —Å:
     - `id` = UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     - `role` = `'student'`
     - `created_at` = —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è

3. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —Ç–µ–º –∂–µ email:**
   - –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ: "An account with this email already exists. Please sign in instead."

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. **–û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ** - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ INSERT –≤ —Ç–∞–±–ª–∏—Ü—É `profiles`
3. **Foreign key constraint** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `id` –≤ `profiles` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `id` –≤ `auth.users`

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è profiles
-- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∞, —Ä–∞–∑—Ä–µ—à–∞—é—â–∞—è INSERT –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

CREATE POLICY "Users can insert their own profile"
ON public.profiles
FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = id);
```

### –ü—Ä–æ–±–ª–µ–º–∞: "User already registered" –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `auth.users`, –Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç –≤ `profiles`

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –≤—Ä—É—á–Ω—É—é –≤ Supabase Dashboard:
   ```sql
   INSERT INTO public.profiles (id, role)
   VALUES ('user-uuid-here', 'student');
   ```
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä (—Å–º. –≤—ã—à–µ), –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–æ—Ñ–∏–ª—å

---

## üìù –†–µ–∑—é–º–µ

‚úÖ **–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `signUpAction`
- –†–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `'student'`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `upsert` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤

‚úÖ **–ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `auth.users`
- ‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `profiles` —Å `role = 'student'`
- ‚úÖ –°–≤—è–∑—å –º–µ–∂–¥—É `auth.users.id` –∏ `profiles.id` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

‚úÖ **–ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ `/auth/login`
